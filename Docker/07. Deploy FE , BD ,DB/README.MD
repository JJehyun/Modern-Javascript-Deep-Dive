# 07. Deploy FE / BE / DB

## í”„ë¡œì íŠ¸ êµ¬ì¡°

- ![image](../../image/d58.png)

## í´ë” êµ¬ì¡°

```bash
/root
    - /backend
        - dockerfile (prod)
        - dockerfile.dev (dev)

    - /frontend
        - nignx (nginx ì„¤ì •)
        - dockerfile (prod)
        - dockerfile.dev (dev)

    - /mysql
        - dockerfile.dev (prod,dev)
        - my.cnf (í•œêµ­ì–´ ì„¤ì •)

    - /nginx
        - dockerfile (prod,dev)
        - default.conf (nginx ì„¤ì •)

    - .travis.yml
        - ci ì½”ë“œ

    - docker-compose.dev.yml
        - í…ŒìŠ¤íŠ¸ í™˜ê²½ ì‹¤í–‰

    - docker-compose.yml
        - Elastic ë°°í¬
```

<br />

## í…ŒìŠ¤íŠ¸ í™˜ê²½ ì½”ë“œ !!

> backend

```docker
# dev
FROM node:14.14.0-alpine

WORKDIR /app

COPY ./package.json ./

RUN npm install

COPY . .

CMD ["npm", "run", "dev"]

# prod
FROM node:14.14.0-alpine

WORKDIR /app

COPY ./package.json ./

RUN npm install

COPY . .

CMD ["npm", "run", "dev"]
```

<br />

```docker
# prod
# ë°°í¬ í™˜ê²½ì„ ìœ„í•œ ë„ì»¤ íŒŒì¼
# ì–´ë˜ : Nginxê°€ ì œê³µì„ í•´ì¤„ BuildíŒŒì¼ì„ ìƒì„±í•˜ëŠ” ë‹¨ê³„ (ì •ì íŒŒì¼ ì œê³µí•˜ëŠ” ë‹¨ê³„)
FROM node:16-alpine as builder
WORKDIR /app
COPY ./package.json ./
RUN npm install
COPY . .
RUN npm run build

# ì•„ë˜ëŠ” Nginxë¥¼ ê°€ë™í•˜ê³  ìœ— ë‹¨ê»˜ì—ì„œ ìƒì„±ëœ ë¹Œë“œíŒŒì¼ë“¤ì„ ì œê³µí•˜ì—¬ì¤€ë‹¤.
# default.confì—ì„œ í•´ì¤€ ì„¤ì •ì„ nginxì»¨í…Œì´ë„ˆ ì•ˆì— ì„¤ì •ë˜ê²Œ ë³µì‚¬í•´ì¤€ë‹¤.
FROM nginx
EXPOSE 3000
# ì»¨í…Œì´ë„ˆ ì•ˆì˜ nignsxì˜ í´í„°ì•ˆì— ë¡œì»¬ì—ì„œ ì ì€ ê°’ìœ¼ë¡œ ë®ì–´ì¤€ë‹¤. (ì»¨í…Œì´ë„ˆ ì•ˆì—ì„œ ë¡œì»¬ì˜ nginxì˜ default.confê°’ì´ í•„ìš”í•¨)
COPY ./nginx/default.conf /etc/nginx/conf.d/default.conf
# ë¹Œë“œ íŒŒì¼ì„ nginxì˜ íŒŒì¼ì— ë„£ì–´ì¤Œ
COPY --from=builder /app/build  /usr/share/nginx/html



# dev
## ê°œë°œ í™˜ê²½ì„ ìœ„í•œ ë„ì»¤ íŒŒì¼
FROM node:16-alpine

WORKDIR /app

COPY package.json ./

RUN npm install

COPY ./ ./

CMD [ "npm", "run", "start" ]

# nginx/default.conf
server {
    # nginxê°€ listení•˜ê³  ìˆëŠ” í¬íŠ¸ / 3000í¬íŠ¸ë¡œ ì ‘ì†í•˜ë©´, nginxê°€ ì œê³µí•˜ëŠ” staticí•œ íŒŒì¼ì„ ë°›ì„ ìˆ˜ ì‡ë‹¤.
    listen 3000;

    location / {
        # '/'ë¡œ ì ‘ì† í–ˆì„ ë•Œ '/usr/share/nginx/html'ì— buildíŒŒì¼ì„ ë„£ì–´ì£¼ë©´, '/'ë¡œ ì ‘ì†í–ˆì„ë•Œ buildíŒŒì¼ì„ ì½ì–´ë“¤ì¼ ìˆ˜ ìˆë‹¤.
        root /usr/share/nginx/html;
        # reactì˜  index.htmlë¥¼ indexë¡œ í•˜ê² ë‹¤ëŠ” ì„¤ì •
        index index.html index.htm;
        # reactë¥¼ ìœ„í•œ ì„¤ì • : ì´ë¶€ë¶„ì´ ì—†ìœ¼ë©´ reactì—ì„œ ë¼ìš°í„° ì´ë™ì´ ë¶ˆê°€ëŠ¥
        try_files $uri  $uri/ /index.html;

    }
}
```

<br />

> mysql

```docker
# prod / dev
# m1 ìš©
# FROM --platform=linux/x86_64 mysql:5.7

FROM --platform=linux/x86_64 mysql:5.7
# ë¡œì»¬ì˜ my.cnf ì»¨í…Œì´ë„ˆì— ë„£ì–´ì¤Œ
# my.cnfëŠ” ë°ì´í„° ë² ì´ìŠ¤ì— í•œê¸€ê°’ì´ ì˜ ë“¤ì–´ê°ˆ ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì†ì„±
# utf8ë¡œ ë³€í™˜
ADD ./my.cnf /etc/mysql/conf.d/my.cnf

# my.cnf
[mysqld]
character-set-server=utf8

[mysql]
default-character-set=utf8

[client]
default-character-set=utf8
```

<br />

> nginx

```docker
# prod / dev
FROM nginx
# nginx ë² ì´ìŠ¤ ì´ë¯¸ì§€ë¡œ ê°€ì ¸ì˜¨ë‹¤ìŒ / ì‘ì„±ëœ confíŒŒì¼ì„ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ë  Nginxì—ë„ ì ìš©ë  ìˆ˜ ìˆê²Œ copy
COPY ./default.conf  /etc/nginx/conf.d/default.conf


# default.conf
upstream frontend {
    # í”„ë¡ íŠ¸ ì—”ë“œê°€ 3000ë²ˆ í¬íŠ¸ì—ì„œ ëŒì•„ê°
    server frontend:3000;
}

upstream backend {
    # ë°±ì—”ë“œê°€ 5000ë²ˆ í¬íŠ¸ì—ì„œ ëŒì•„ê°
    server backend:5000;
}

server {
    # nginx ì„œë²„í¬íŠ¸ 80ë²ˆì„ ì—´ì–´ì¤Œ
    listen 80;

    location / {
        # docker-composeì—ì„œ ì‘ì„±í•œ servicedì´ë¦„
        proxy_pass http://frontend;
    }

    location /api {
        # docker-composeì—ì„œ ì‘ì„±í•œ servicedì´ë¦„
        proxy_pass http://backend;
    }

    # ê°œë°œí™˜ê²½ì—ì„œ ì—ëŸ¬ë¥¼ ì¡ê¸°ìœ„í•´ ì‘ì„±
    location /sockjs-node {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

}
```

```
í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¸íŒ… ë

ğŸ”¥docker-compose up --buildğŸ”¥

ë¡œ ë¡œì»¬ í…ŒìŠ¤íŠ¸
```

<br />
<br />
<br />

---

---

---

<br />
<br />
<br />

# ë°°í¬ ì§„í–‰

## ì „ì²´ì ì¸ êµ¬ì¡°

```
1. [ì½”ë“œ push]

2. Travis CIê°€ ì½”ë“œë¥¼ ê°€ì ¸ì˜¤ê³  í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰

3. Travis CI test ì„±ê³µ ì‹œ ì´ë¯¸ì§€ Build

3. ë¹Œë“œëœ ì´ë¯¸ì§€ Docker Hubë¡œ ì „ì†¡
- Docker Hubì— ë¹Œë“œëœ ì´ë¯¸ì§€ë¥¼ ë³´ë‚´ê³  AWSì—ì„œ ê·¸ ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ê°€ì„œ EBì—ì„œ ë‹¤ì‹œ ë¹Œë“œ í•˜ì§€ ì•Šì•„ë„ ëœë‹¤.

4. AWS EBì— DockerHubì— ì´ë¯¸ì§€ë¥¼ ë³´ëƒˆë‹¤ê³  ì•Œë¦¼

5. AWS EBì—ì„œ DockerHubì— ìˆëŠ” ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜¨ í›„ì— ë°°í¬ë¥¼ ì§„í–‰
```

<br />
<br />

## travis.yml ci ì½”ë“œ ì‘ì„± (1)

```yml
language: generic

sudo: required

# ë„ì»¤ í™˜ê²½ì„
services:
  - docker
# ë„ì»¤ ì´ë¯¸ì§€ ìƒì„±
before_install:
  - docker build -t jjehyun/react-test-app -f ./frontend/Dockerfile.dev ./frontend
# ìœ„ì—ì„œ ë§Œë“  ì´ë¯¸ì§€ë¥¼ í†µí•´ í…ŒìŠ¤íŠ¸ ì§„í–‰
script:
  - docker run -e CI=true jjehyun/react-test-app npm run test

## í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆë‹¤ë©´, í•˜ë‚˜í•˜ë‚˜ì˜ í”„ë¡œì íŠ¸ì˜ ìš´ì˜ë²„ì „ ì´ë¯¸ì§€ë¥¼ ë¹Œë“œ(ìƒì„±)í•˜ëŠ” ì„¤ì •í•˜ê¸°
after_success:
  - docker build -t jjehyun/docker-frontend ./frontend
  - docker build -t jjehyun/docker-backend ./backend
  - docker build -t jjehyun/docker-nginx ./nginx
  # ë„ì»¤í—ˆë¸Œì— ìƒì„±í•œ ì´ë¯¸ì§€ë¥¼ ë„£ì–´ì£¼ì–´ì•¼í•¨, ë„ì»¤ í—ˆë¸Œì— ë¡œê·¸ì¸í•˜ëŠ” ì½”ë“œ (DOCKER_HUB_PASSWORD,DOCKER_HUB_ID travis-ciì—ì„œ ì„¤ì • ê°’)
  - echo "$DOCKER_HUB_PASSWORD" | docker login -u "$DOCKER_HUB_ID" --password-stdin
  # ìƒì„±ëœ ë„ê±° ì´ë¯¸ì§€ë¥¼ í•˜ë‚˜ì”© ë„ì»¤ í—ˆë¸Œì— push
  - docker push jjehyun/docker-frontend
  - docker push jjehyun/docker-backend
  - docker push jjehyun/docker-nginx

deploy:
  provider: elasticbeanstalk
  region: "us-east-2"
  app: "dockerFull"
  env: "DockerFull-env"
  #S3ì´ë¦„
  bucket_name: elasticbeanstalk-us-east-2-773778816275
  bucket_path: "dockerFull"
  on:
    branch: master

  access_key_id: $AWS_ACCESS_KEY
  secret_access_key: $AWS_SECRET_ACCESS_KEY
```

<br />
<br />

## Dockerrun.aws.json

- ![image](../../image/d68.png)

> dockerfileì´ ë§ì€ ë©€í‹° í”„ë¡œê·¸ë¦¼ì—ì„œ ì‚¬ìš©

> ì–´ë–»ê²Œ ë‹¤ì¤‘ ì»¨í…Œì´ë„ˆë¥¼ ì‘ë™ ì‹œí‚¬ì§€ ì•Œë ¤ì¤€ë‹¤.

```bash
# Dockerrun.aws.json
# ì„¤ëª…
{
    # hostnameì´ë¦„ì„ í†µí•´ ì»¨í…Œì´ë„ˆê°„ì˜ ì†Œí†µì´ ê°€ëŠ¥í•˜ë‹¤.
    # ë²„ì „ ëª…ì‹œ
    # essential : trueë©´ ë‹¤ë¥¸ ì‘ì—…ë„ ì¤‘ì§€
    "AWSEBDockerrunVersion":2,
    # ì´ì•ˆì— ì»¨í…Œì´ë„ˆë¥¼ ì •ì˜í•´ì¤€ë‹¤ (í”„ë¡ íŠ¸,ë°±,db,nginx)
    "containerDefinitions":{
        "name":"frontend",
        # êµ¬ì¶•í•  ì˜¨ë¼ì¸ Dockerë¦¬í¬ì§€í† ë¦¬ì˜ Dockerì´ë¯¸ì§€ ì´ë¦„ ë„ì»¤ì— ì˜¬ë¦° ì´ë¯¸ì§€ ì´ë¦„
        "image":"jjehyun/docker-frontend",
        "hostname":"frontend",
        "essential":false,
        "memory":128
    },{
        "name":"backend",
        # êµ¬ì¶•í•  ì˜¨ë¼ì¸ Dockerë¦¬í¬ì§€í† ë¦¬ì˜ Dockerì´ë¯¸ì§€ ì´ë¦„ ë„ì»¤ì— ì˜¬ë¦° ì´ë¯¸ì§€ ì´ë¦„
        "image":"jjehyun/docker-backend",
        "hostname":"backend",
        "essential":false,
        "memory":128
    },{
        "name":"nginx",
        # êµ¬ì¶•í•  ì˜¨ë¼ì¸ Dockerë¦¬í¬ì§€í† ë¦¬ì˜ Dockerì´ë¯¸ì§€ ì´ë¦„ ë„ì»¤ì— ì˜¬ë¦° ì´ë¯¸ì§€ ì´ë¦„
        "image":"jjehyun/docker-nginx",
        "hostname":"nginx",
        "essential":true,
        "memory":128,
        "portMappings":[
            {
            "hostPort":80,
            "containerPort":80
            }
        ],
        # nginxì™€ frontend | backend ì—°ê²°ë¨
        "links":["frontend","backend"],
        "memory":128
    }
}


```

<br />
<br />

## Elastic Beanstalk / RDS í•œë²ˆì— í™˜ê²½ ì„¸íŒ… (2)

- ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒì„±
  - í™˜ê²½ êµ¬ì„± : âœ… ì›¹ ì„œë²„
  - í”Œë«í¼ : âœ… 64bit Amazon Linux 2
    - `ì„œë¹„ìŠ¤ ì—‘ì„¸ìŠ¤`
      - ê¸°ì¡´ ì—­í•  : âœ… aws-elasticbeanstalk-ec2-role
      - EC2 ì¸ìŠ¤í„´ìŠ¤ í”„ë¡œíŒŒì¼ : aws-elasticbeanstalk-ec2-role
        - `ë„¤íŠ¸ì›Œí‚¹, ë°ì´í„° ë² ì´ìŠ¤`
          - ë°ì´í„° ë² ì´ìŠ¤ : - , mysql ,ìŠ¤í† ë¦¬ì§€ 5
          - Virtual Private Cloud
            - `ì¸ìŠ¤í„´ìŠ¤ íŠ¸ë˜í”½ ë° í¬ê¸° ì¡°ì •..`
            - ì•„í‚¤í…ì²˜ : t3.micro

> Elastic Beanstalk ìƒì„± ì™„ë£Œ

> RDS ìƒì„± ì™„ë£Œ

<br />

## VPC -> ë³´ì•ˆ -> ë³´ì•ˆê·¸ë£¹ -> ë³´ì•ˆê·¸ë£¹ ìƒì„±í•˜ê¸°

- ![image](../../image/d70.png)

```
- ì¸ ë°”ìš´ë“œëŠ” ë°ì´í„° ë² ì´ìŠ¤ì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë¶€ë¶„
```

<br />
<br />

- `ë³´ì•ˆ ê·¸ë£¹ ìƒì„±`
  - ë³´ì•ˆ ê·¸ë£¹ ì´ë¦„ : DockerSecurityGroup
  - ì„¤ëª… : allow (ë„ì»¤ì•ˆì— ì„œë¹„ìŠ¤ ì°¸ì¡° ê°€ëŠ¥)
  - `ì„¸ë¶€ ì ì¸ ì„ íƒ ì—†ì´ ë³´ì•ˆê·¸ë£¹ ìƒì„± ì™„ë£Œ`
- ê·¸ í›„
  - ë¦¬ë‹¤ì´ë ‰ì…˜ ëœ í˜ì´ì§€ì—ì„œ ì¸ë°”ìš´ë“œ ê·œì¹™ í¸ì§‘ í´ë¦­
  - ![image](../../image/d69.png)

<br />
<br />
<br />

## ìœ„ì—ì„œ ë§Œë“  ë³´ì•ˆê·¸ë£¹ì„ EB | RDSì— ì ìš©í•˜ê¸° (3)

- RDS

  - ì¸ìŠ¤í„´ìŠ¤ - ìˆ˜ì • - ì¦‰ì‹œ ìˆ˜ì •
  - ![image](../../image/d72.png)

- Elastic Beanstic
  - Elastic Beanstalk - í™˜ê²½ - êµ¬ì„± - ì¸ìŠ¤í„´ìŠ¤ - í¸ì ‘
  - ![image](../../image/d73.png)

<br />

> RDS / EB ë‘˜ ë‹¤ DockerSecurityGroup ë³´ì•ˆê·¸ë£¹ ì ìš© ì™„ë£Œ

> RDS / EB ë³´ì•ˆ ê·¸ë£¹ì„ ì„œë¡œ ê°™ê²Œ í•´ì¤Œìœ¼ë¡œì¨ RDS / EB ì„œë¡œ í†µì‹ ì´ ê°€ëŠ¥í•˜ê²Œ ë¨

<br />
<br />

## RDS ì™€ EB í™˜ê²½ ë³€ìˆ˜ ì ìš© í•˜ê¸°

- ![image](../../image/d74.png)
- ![image](../../image/d75.png)

- Elastic Beanstalk í™˜ê²½ ë³€ìˆ˜
  - í™˜ê²½ - êµ¬ì„± - ì—…ë°ì´íŠ¸,ëª¨ë‹ˆí„°ë§ ë¡œê¹… êµ¬ì„±
  - í™˜ê²½ ë³€ìˆ˜ ì¶”ê°€
    - ![image](../../image/d76.png)

> RDS , EB í™˜ê²½ ë³€ìˆ˜ ì„¸íŒ… ì™„ë£Œ
